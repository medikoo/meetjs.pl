'use strict';

var startsWith   = require('es5-ext/lib/String/starts-with').call
  , navigator    = require('./navigator')

document.addEventListener('click', function (e) {
	var hash, el = e.target;
	if (!history.pushState || e.metaKey || e.ctrlKey || (e.which === 2)) {
		return;
	}
	while (el && (el.nodeName.toLowerCase() !== 'a')) {
		el = el.parentNode;
	}
	if (!el || !el.href || (el.protocol !== location.protocol) ||
		 (el.host !== location.host) || startsWith(el.pathname, '/file/')) {
		return;
	}

	e.stopPropagation();
	if ((el.pathname !== location.pathname) || (el.search !== location.search) || !el.hash) {
		e.preventDefault();
	}

	navigator.load(el.href);
	if (el.hash) {
		location.href = el.hash;
	}
}, true);

window.addEventListener('hashchange', navigator.update, false);
